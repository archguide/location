<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Arch Guide â€“ Buildings Map</title>

  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" crossorigin></script>

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --- CONFIG (YOUR KEYS) ---
    const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zdXptcmZ6emtxZmZocGlsaXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjY5NDAsImV4cCI6MjA4MjM0Mjk0MH0.kGHLaDT2FR9AAnZjP96FgAcSPjCQm6w9ifAqd6cEOoQ';

    const MAPKIT_TOKEN =
      'eyJraWQiOiJSN05HVzZZNko3IiwidHlwIjoiRVMyNTYifQ.eyJpc3MiOiI4N05MV1VQUVFBIiwiaWF0IjoxNzY3NjcxMDk2LCJvcmlnaW4iOiJhcmNoZ3VpZGUuZ2l0aHViLmlvIn0.aGopUszusE4HfaiqItorz1NoVxzy5z46YItwrq43WVgyERsMm8kkmLZMJNUHd83c-icIhRra2mBFwgpdvYk-SA';

    const NEIGHBORHOOD_COLORS = {
      DTL: '#1150AB',
      SLV: '#2E7D6F',
      PAS: '#C56B3C',
      LFZ: '#E85D75',
      WHO: '#F4A261'
    };

    // --- URL PARAMS ---
    const params = new URLSearchParams(window.location.search);
    const USER_ID = params.get('user_id');
    const TOUR_ID = params.get('tour_id');

    if (!USER_ID) {
      document.body.innerHTML = '<div style="padding:20px;color:red;">Error: user_id required</div>';
      throw new Error('USER_ID missing');
    }

    // --- MAPKIT INIT ---
    mapkit.init({
      authorizationCallback: done => done(MAPKIT_TOKEN)
    });

    const DEFAULT_CENTER = new mapkit.Coordinate(34.0522, -118.2437);

    const map = new mapkit.Map('map', {
      center: DEFAULT_CENTER,
      region: new mapkit.CoordinateRegion(
        DEFAULT_CENTER,
        new mapkit.CoordinateSpan(0.4, 0.5)
      ),

      // ðŸ”µ USER LOCATION (THIS IS WHAT YOU ASKED FOR)
      showsUserLocation: true,
      tracksUserLocation: false,
      showsUserLocationControl: true,

      showsCompass: mapkit.FeatureVisibility.Hidden,
      showsScale: false,
      showsMapTypeControl: false,
      isZoomEnabled: true,
      isScrollEnabled: true
    });

    // --- ZOOM TO USER ON FIRST FIX ---
    let didZoomToUser = false;

    map.addEventListener('user-location-change', event => {
      if (!event.coordinate || didZoomToUser) return;

      didZoomToUser = true;

      map.setRegion(
        new mapkit.CoordinateRegion(
          event.coordinate,
          new mapkit.CoordinateSpan(0.02, 0.02)
        ),
        true
      );
    });

    // --- STATE ---
    let allBuildings = [];
    let unlockedSet = new Set();
    let tourStops = [];
    let tourRoute = [];
    let buildingAnnotations = [];
    let routePolylines = [];

    // --- SUPABASE FETCH ---
    async function supaJson(path) {
      const res = await fetch(`${SUPABASE_URL}${path}`, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          Accept: 'application/json'
        }
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // --- LOAD DATA ---
    async function loadBuildingsOnce() {
      allBuildings = await supaJson(
        '/rest/v1/buildings?select=id,title,latitude,longitude,image,neighborhood_id,is_free'
      );
    }

    async function loadUnlockedOnce() {
      try {
        const rows = await supaJson(
          `/rest/v1/user_building_unlocks?user_id=eq.${USER_ID}&select=building_id`
        );
        unlockedSet = new Set(rows.map(r => r.building_id));
      } catch {
        unlockedSet = new Set();
      }
    }

    async function loadTourData(tourId) {
      if (!tourId) return;

      tourStops = await supaJson(
        `/rest/v1/tour_stops?tour_id=eq.${tourId}&select=building_id,stop_order&order=stop_order`
      );

      try {
        tourRoute = await supaJson(
          `/rest/v1/tour_routes?tour_id=eq.${tourId}&select=route_points,route_order&order=route_order`
        );
      } catch {
        tourRoute = [];
      }
    }

    // --- MAP HELPERS ---
    function clearPins() {
      buildingAnnotations.forEach(a => map.removeAnnotation(a));
      buildingAnnotations = [];
    }

    function clearRoutes() {
      routePolylines.forEach(p => map.removeOverlay(p));
      routePolylines = [];
    }

    function fitToPins() {
      if (!buildingAnnotations.length) return;

      let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;

      buildingAnnotations.forEach(a => {
        minLat = Math.min(minLat, a.coordinate.latitude);
        maxLat = Math.max(maxLat, a.coordinate.latitude);
        minLng = Math.min(minLng, a.coordinate.longitude);
        maxLng = Math.max(maxLng, a.coordinate.longitude);
      });

      map.setRegion(
        new mapkit.CoordinateRegion(
          new mapkit.Coordinate((minLat + maxLat) / 2, (minLng + maxLng) / 2),
          new mapkit.CoordinateSpan(
            Math.max(maxLat - minLat, 0.01),
            Math.max(maxLng - minLng, 0.01)
          )
        ),
        true
      );
    }

    function addPins(buildings) {
      clearPins();

      buildings.forEach(b => {
        if (!b.latitude || !b.longitude) return;

        const ann = new mapkit.MarkerAnnotation(
          new mapkit.Coordinate(+b.latitude, +b.longitude),
          {
            color: NEIGHBORHOOD_COLORS[b.neighborhood_id] || '#666',
            title: b.title,
            data: b
          }
        );

        ann.callout = {
          calloutElementForAnnotation: annotation => {
            const el = document.createElement('div');
            el.style.cssText = `
              width:155px;height:155px;border-radius:12px;
              overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.25);
            `;
            el.innerHTML = b.image
              ? `<img src="${b.image}" style="width:100%;height:100%;object-fit:cover;">`
              : `<div style="background:#ddd;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">No Image</div>`;

            el.onclick = () => {
              window.ReactNativeWebView?.postMessage(JSON.stringify({
                action: 'navigateToBuilding',
                buildingId: b.id
              }));
            };
            return el;
          }
        };

        map.addAnnotation(ann);
        buildingAnnotations.push(ann);
      });

      fitToPins();
    }

    function addRoutePolylines() {
      clearRoutes();

      tourRoute.forEach(segment => {
        const points = JSON.parse(segment.route_points || '[]');
        if (points.length < 2) return;

        const coords = points.map(p => new mapkit.Coordinate(p.lat, p.lng));

        const polyline = new mapkit.PolylineOverlay(coords, {
          style: new mapkit.Style({
            strokeColor: '#1150AB',
            strokeWidth: 4,
            strokeOpacity: 0.8
          })
        });

        map.addOverlay(polyline);
        routePolylines.push(polyline);
      });
    }

    // --- FILTER LOGIC ---
    function applyFilters() {
      if (TOUR_ID) {
        const stopIds = new Set(tourStops.map(s => s.building_id));
        addPins(allBuildings.filter(b => stopIds.has(b.id)));
        addRoutePolylines();
      } else {
        addPins(allBuildings);
      }
    }

    // --- INIT ---
    (async function init() {
      await loadBuildingsOnce();
      await loadUnlockedOnce();
      await loadTourData(TOUR_ID);
      applyFilters();
    })();
  </script>
</body>
</html>
